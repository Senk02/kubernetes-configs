apiVersion: v1
kind: ConfigMap
metadata:
  name: metrics-proxy-app
data:
  package.json: |
    {
      "name": "profile-site",
      "version": "1.0.0",
      "type": "module",
      "scripts": {
        "dev": "vite",
        "build": "vite build",
        "preview": "vite preview",
        "start": "node server.js"
      },
      "dependencies": {
        "express": "^4.21.2",
        "lucide-react": "^0.263.1",
        "react": "^18.2.0",
        "react-dom": "^18.2.0"
      },
      "devDependencies": {
        "@vitejs/plugin-react": "^4.0.0",
        "autoprefixer": "^10.4.14",
        "postcss": "^8.4.24",
        "tailwindcss": "^3.3.0",
        "vite": "^4.3.9"
      }
    }
  server.js: |
    import express from 'express';
    import path from 'path';
    import { fileURLToPath } from 'url';

    const __filename = fileURLToPath(import.meta.url);
    const __dirname = path.dirname(__filename);

    const app = express();
    const PORT = process.env.PORT || 3000;
    const PROMETHEUS_URL = process.env.PROMETHEUS_URL || 'http://prometheus.monitoring.svc.cluster.local:9090';

    // Serve static files from dist
    app.use(express.static(path.join(__dirname, 'dist')));

    // Controlled API endpoint - only returns specific metrics
    app.get('/api/metrics', async (req, res) => {
      try {
        // Fetch only the specific metrics we want to expose
        const [containerResponse, cpuResponse] = await Promise.all([
          fetch(`${PROMETHEUS_URL}/api/v1/query?query=count(count(container_last_seen)by(name))`),
          fetch(`${PROMETHEUS_URL}/api/v1/query_range?query=sum(rate(container_cpu_usage_seconds_total{container!=""}[5m]))&start=${Date.now()/1000 - 3600}&end=${Date.now()/1000}&step=60`)
        ]);

        const containerData = await containerResponse.json();
        const cpuData = await cpuResponse.json();

        // Only return sanitized, specific data
        res.json({
          containerCount: containerData.data?.result?.[0]?.value?.[1] || null,
          cpuUsage: cpuData.data?.result?.[0]?.values || []
        });
      } catch (error) {
        console.error('Error fetching metrics:', error);
        res.status(500).json({ error: 'Failed to fetch metrics' });
      }
    });

    app.listen(PORT, () => {
      console.log(`Metrics API server running on port ${PORT}`);
    });
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-metrics-config
data:
  metrics.conf: |
    server {
        listen 80;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # Serve static files
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Proxy to Node.js sidecar for metrics
        location /api/metrics {
            proxy_pass http://localhost:3000/api/metrics;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }