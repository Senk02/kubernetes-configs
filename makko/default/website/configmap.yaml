apiVersion: v1
kind: ConfigMap
metadata:
  name: metrics-proxy-app
data:
  package.json: |
    {
      "name": "metrics-proxy",
      "version": "1.0.0",
      "main": "server.js",
      "dependencies": {
        "express": "^4.18.2"
      }
    }
  server.js: |
    const express = require('express');
    const http = require('http');
    const url = require('url');
    
    const app = express();
    const PORT = 3000;
    const PROMETHEUS_URL = process.env.PROMETHEUS_URL || 'http://prometheus.monitoring.svc.cluster.local:9090';
    
    // Fetch data from Prometheus and sanitize it
    async function fetchAndSanitizeMetrics(query) {
      return new Promise((resolve, reject) => {
        const prometheusUrl = `${PROMETHEUS_URL}/api/v1/query?query=${encodeURIComponent(query)}`;
        const parsedUrl = url.parse(prometheusUrl);
        
        const options = {
          hostname: parsedUrl.hostname,
          port: parsedUrl.port || 9090,
          path: parsedUrl.path,
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        };
        
        const req = http.request(options, (res) => {
          let data = '';
          
          res.on('data', (chunk) => {
            data += chunk;
          });
          
          res.on('end', () => {
            try {
              const parsed = JSON.parse(data);
              
              // Sanitize: extract only numeric values, remove labels and metadata
              if (parsed.status === 'success' && parsed.data && parsed.data.result) {
                const sanitized = parsed.data.result.map(item => {
                  const value = item.value && item.value[1] ? parseFloat(item.value[1]) : null;
                  return { value };
                });
                resolve({ status: 'success', data: sanitized });
              } else {
                resolve({ status: 'success', data: [] });
              }
            } catch (err) {
              reject(err);
            }
          });
        });
        
        req.on('error', (err) => {
          reject(err);
        });
        
        req.end();
      });
    }
    
    // API endpoint
    app.get('/api/metrics', async (req, res) => {
      try {
        const query = req.query.query || 'up';
        const sanitizedData = await fetchAndSanitizeMetrics(query);
        res.json(sanitizedData);
      } catch (error) {
        console.error('Error fetching metrics:', error);
        res.status(500).json({ status: 'error', error: 'Failed to fetch metrics' });
      }
    });
    
    // Health check endpoint
    app.get('/health', (req, res) => {
      res.json({ status: 'ok' });
    });
    
    app.listen(PORT, '127.0.0.1', () => {
      console.log(`Metrics proxy listening on localhost:${PORT}`);
      console.log(`Prometheus URL: ${PROMETHEUS_URL}`);
    });
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-metrics-config
data:
  metrics.conf: |
    location /api/metrics {
        proxy_pass http://localhost:3000/api/metrics;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
